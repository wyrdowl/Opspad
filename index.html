<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>OpsPad ‚Äî All-in-One</title>
<style>
  :root {
    --bg:#0a0a0a; --panel:#131316; --text:#f5f5f7; --muted:#a1a1aa; --border:#27272a;
    --tab-bg:#0f0f13; --tab-active:#ffffff; --tab-inactive:#a1a1aa;
  }
  * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
  .wrap { display:flex; flex-direction:column; min-height:100dvh; }

  header { position:sticky; top:0; z-index:10; padding:14px 16px;
    background:linear-gradient(180deg,rgba(10,10,10,.95),rgba(10,10,10,0));
    border-bottom:1px solid var(--border); backdrop-filter:blur(6px); }
  header h1 { margin:0; font-size:18px; font-weight:800; letter-spacing:-.01em; }
  header .sub { font-size:12px; color:var(--muted); margin-top:2px; }

  main { flex:1; padding:16px; padding-bottom:148px; }
  main > section { max-width:900px; margin-inline:auto; }
  .card { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .hidden { display:none; }
  h2 { margin:0 0 10px; font-size:18px; font-weight:800; padding-bottom:6px; border-bottom:1px solid var(--border); }
  p { color:var(--muted); margin:8px 0 0; }

  input, textarea, select { width:100%; background:#111116; border:1px solid var(--border); color:var(--text); border-radius:12px; padding:12px; font-size:14px; }
  .btn { -webkit-appearance:none; appearance:none; background:#fff; color:#111; font-weight:700; padding:10px 14px; border-radius:12px; border:none; }
  .btn.ghost { background:#1b1b21; color:#e5e5e5; border:1px solid var(--border); }

  /* key/value grid */
  .kv { display:grid; grid-template-columns:140px 1fr; gap:8px 12px; align-items:center; }
  .kv .k { color:#c9c9d6; font-size:12px; }
  .kv .v { font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:13px; }
  .center { text-align:center; color:var(--muted); font-size:12px; }

  /* Tabs */
  nav.tabs { position:fixed; left:0; right:0; bottom:0; z-index:20;
    display:grid; grid-template-columns:repeat(7,1fr); background:var(--tab-bg); border-top:1px solid var(--border); }
  nav .tab { background:none; border:0; padding:10px 6px; color:var(--tab-inactive); font-size:11px; font-weight:700; }
  nav .tab[aria-selected="true"] { color:var(--tab-active); }

  /* Viz */
  #viz-canvas { width:100%; height:340px; border-radius:16px; border:1px solid var(--border);
    background:radial-gradient(1200px 600px at 20% 0%,#121219 0%,#0a0a0a 60%); }

  /* Rangefinder */
  .range-wrap { position:relative; }
  #range-video { width:100%; height:360px; object-fit:cover; border-radius:16px; border:1px solid var(--border); background:#000; }
  .range-overlay { position:absolute; inset:0; pointer-events:none; border-radius:16px; }
  .range-crosshair { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:140px; height:140px; border:1px solid rgba(255,255,255,.45); border-radius:50%; }
  .range-crosshair:before, .range-crosshair:after { content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,.7); }
  .range-crosshair:before { width:1px; height:120px; }
  .range-crosshair:after  { width:120px; height:1px; }
  .range-hud { position:absolute; left:12px; top:12px; background:rgba(0,0,0,.35); color:#fff; font-size:12px; padding:6px 8px; border-radius:10px; backdrop-filter:blur(4px); }
  .range-bottom { position:absolute; left:12px; right:12px; bottom:12px; display:flex; justify-content:space-between; gap:10px; pointer-events:none; }
  .range-tag { background:rgba(0,0,0,.35); color:#fff; font-size:12px; padding:6px 8px; border-radius:10px; }

  /* Attitude canvas */
  #gyro-canvas { width:100%; height:180px; border-radius:16px; border:1px solid var(--border); background:#0b0f18; }

  /* Tasks list */
  ul.list { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
  .pill { width:18px; height:18px; border-radius:50%; border:1.5px solid #6b7280; display:inline-grid; place-items:center; margin-right:8px; background:transparent; }
  .pill.done { background:#fff; border-color:#fff; }
  .strike { text-decoration: line-through; opacity: .6; }

  @media (max-width:480px){
    main { padding-bottom:156px; }
    .kv { grid-template-columns:112px 1fr; }
    .row > label { width:100%; }
    .row > select, .row > input[type="range"], .row > button { flex:1; }
  }
</style>
</head>
<body>
<noscript style="color:white;background:#b00020;display:block;padding:8px 12px;">
  This app needs JavaScript enabled.
</noscript>

<div class="wrap">
  <header>
    <h1>OpsPad</h1>
    <div class="sub">offline-first ‚Ä¢ one tab visible</div>
  </header>

  <main>
    <!-- TASKS -->
    <section id="view-tasks" role="region" aria-labelledby="tab-tasks">
      <div class="card">
        <h2>üìã Tasks</h2>
        <form id="task-form" class="row">
          <input id="task-input" placeholder="Add a task‚Ä¶" />
          <button class="btn" type="submit">Add</button>
        </form>
        <div class="row" style="justify-content:space-between;margin-top:8px;">
          <div class="center" id="remaining"></div>
          <button id="clear-done" class="btn ghost" type="button">Clear done</button>
        </div>
        <ul id="task-list" class="list" style="margin-top:8px;"></ul>
      </div>
    </section>

    <!-- NOTES -->
    <section id="view-notes" class="hidden" role="region" aria-labelledby="tab-notes">
      <div class="card">
        <h2>üìù Notes</h2>
        <form id="note-form" class="row">
          <input id="note-title" placeholder="Title (optional)" />
          <textarea id="note-body" rows="3" placeholder="Write a note‚Ä¶"></textarea>
          <div style="flex:1"></div>
          <button class="btn" type="submit">Save</button>
        </form>
        <ul id="note-list" class="list" style="margin-top:8px;"></ul>
      </div>
    </section>

    <!-- TIMER -->
    <section id="view-timer" class="hidden" role="region" aria-labelledby="tab-timer">
      <div class="card">
        <h2>‚è≤Ô∏è Timer</h2>
        <div class="center" id="timer-readout" style="font-size:40px;font-weight:800;">25:00</div>
        <div class="row" style="margin-top:8px;">
          <button id="timer-start" class="btn">Start</button>
          <button id="timer-reset" class="btn ghost">Reset</button>
          <label>Minutes</label>
          <input type="range" id="timer-range" min="5" max="90" value="25" />
        </div>
      </div>
    </section>

    <!-- BPM -->
    <section id="view-bpm" class="hidden" role="region" aria-labelledby="tab-bpm">
      <div class="card">
        <h2>üéµ BPM</h2>
        <div class="center" style="text-transform:uppercase;letter-spacing:.2em;">Average BPM</div>
        <div id="bpm-value" class="center" style="font-size:46px;font-weight:900;">‚Äî</div>
        <div id="bpm-ms" class="center" style="font-size:12px;"></div>
        <div class="row" style="justify-content:center;margin-top:8px;">
          <button id="bpm-tap" class="btn" style="width:160px;height:160px;border-radius:999px;font-size:24px;">TAP</button>
          <button id="bpm-reset" class="btn ghost">Reset</button>
        </div>
      </div>
    </section>

    <!-- VIZ -->
    <section id="view-viz" class="hidden" role="region" aria-labelledby="tab-viz">
      <div class="card" style="display:flex;flex-direction:column;gap:12px;">
        <h2>üåà Visualizer</h2>
        <canvas id="viz-canvas"></canvas>
        <div class="row">
          <button id="viz-start" class="btn">Start Mic</button>
          <button id="viz-stop" class="btn ghost">Stop</button>
          <label>Mode</label>
          <select id="viz-mode"><option value="bars">Bars</option><option value="circle" selected>Circle</option></select>
          <label>Sensitivity</label>
          <input type="range" id="viz-sens" min="0.6" max="2.5" step="0.1" value="1.2" />
          <label>Circle size</label>
          <input type="range" id="viz-circle" min="0.18" max="0.45" step="0.01" value="0.28" />
        </div>
        <div id="viz-status" class="center"></div>
      </div>
    </section>

    <!-- RANGE -->
    <section id="view-range" class="hidden" role="region" aria-labelledby="tab-range">
      <div class="card">
        <h2>üìê Rangefinder</h2>
        <div class="range-wrap">
          <video id="range-video" playsinline muted autoplay></video>
          <div class="range-overlay">
            <div class="range-hud" id="range-hud">pitch ‚Äî¬∞ ‚Ä¢ depression ‚Äî¬∞</div>
            <div class="range-crosshair"></div>
            <div class="range-bottom">
              <div class="range-tag" id="range-distance">distance ‚Äî</div>
              <div class="range-tag" id="range-face">face ‚Äî</div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="range-start" class="btn">Start Camera</button>
          <button id="range-stop" class="btn ghost">Stop</button>
          <button id="range-sensors" class="btn ghost">Enable Sensors</button>

          <label>Height (m)</label>
          <input type="range" id="range-height" min="0.3" max="2.5" step="0.01" value="1.60" />

          <label>Units</label>
          <select id="range-units"><option value="m" selected>meters</option><option value="ft">feet</option></select>

          <button id="range-cal" class="btn ghost">Calibrate</button>
          <button id="range-lock" class="btn ghost">Lock</button>
        </div>
        <div class="center" id="range-status" style="margin-top:6px;"></div>
      </div>
    </section>

    <!-- SENSORS -->
    <section id="view-sensors" class="hidden" role="region" aria-labelledby="tab-sensors">
      <div class="card" style="display:flex;flex-direction:column;gap:12px;">
        <h2>üì° Sensors</h2>
        <div class="row">
          <button id="sns-orient" class="btn ghost">Enable Orientation</button>
          <button id="sns-magnet" class="btn ghost">Enable Magnetometer</button>
          <button id="sns-light" class="btn ghost">Enable Ambient Light</button>
          <button id="sns-gps" class="btn ghost">Enable GPS</button>
        </div>

        <div id="sns-status" class="center"></div>

        <div class="kv">
          <div class="k">Pitch / Roll</div><div class="v" id="sns-pr">‚Äî</div>
          <div class="k">Heading</div><div class="v" id="sns-head">‚Äî</div>
          <div class="k">Face</div><div class="v" id="sns-face">‚Äî</div>
        </div>

        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button id="h-cal" class="btn ghost">Calibrate level</button>
            <button id="h-flip" class="btn ghost">Flip horizon</button>
          </div>
          <div id="h-label" class="center"></div>
        </div>
        <canvas id="gyro-canvas"></canvas>

        <div class="kv" style="margin-top:8px;">
          <div class="k">Magnetometer (¬µT)</div><div class="v" id="sns-mag">‚Äî</div>
          <div class="k">|B|</div><div class="v" id="sns-mag-mag">‚Äî</div>
          <div class="k">Mag status</div><div class="v" id="sns-mag-status">Not started</div>

          <div class="k">Ambient light</div><div class="v" id="sns-lux">‚Äî</div>
          <div class="k">Light status</div><div class="v" id="sns-lux-status">Not started</div>

          <div class="k">GPS lat/lon</div><div class="v" id="sns-ll">‚Äî</div>
          <div class="k">GPS accuracy</div><div class="v" id="sns-acc">‚Äî</div>
          <div class="k">Altitude</div><div class="v" id="sns-alt">‚Äî</div>
          <div class="k">Speed / Heading</div><div class="v" id="sns-speed">‚Äî</div>
          <div class="k">GPS status</div><div class="v" id="sns-gps-status">Not started</div>

          <div class="k">Barometer</div><div class="v">Not available in browsers (native only)</div>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabs" role="tablist" aria-label="Primary">
    <button id="tab-tasks"   class="tab" role="tab" aria-selected="true"  data-tab="tasks"   aria-controls="view-tasks"   type="button">Tasks</button>
    <button id="tab-notes"   class="tab" role="tab" aria-selected="false" data-tab="notes"   aria-controls="view-notes"   type="button">Notes</button>
    <button id="tab-timer"   class="tab" role="tab" aria-selected="false" data-tab="timer"   aria-controls="view-timer"   type="button">Timer</button>
    <button id="tab-bpm"     class="tab" role="tab" aria-selected="false" data-tab="bpm"     aria-controls="view-bpm"     type="button">BPM</button>
    <button id="tab-viz"     class="tab" role="tab" aria-selected="false" data-tab="viz"     aria-controls="view-viz"     type="button">Viz</button>
    <button id="tab-range"   class="tab" role="tab" aria-selected="false" data-tab="range"   aria-controls="view-range"   type="button">Range</button>
    <button id="tab-sensors" class="tab" role="tab" aria-selected="false" data-tab="sensors" aria-controls="view-sensors" type="button">Sensors</button>
  </nav>
</div>

<script>
/* ===== Helpers (ES2018-safe) ===== */
var $ = function(s){ return document.querySelector(s) };
var $$ = function(s){ return Array.from(document.querySelectorAll(s)) };

var storage = {
  get: function(k, fallback){
    try {
      var raw = localStorage.getItem(k);
      if (raw === null) return fallback;
      var val = JSON.parse(raw);
      return (typeof val === "undefined") ? fallback : val;
    } catch (e) { return fallback; }
  },
  set: function(k, v){
    try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) {}
  }
};

function degreesToCardinal(deg){
  if(deg==null || isNaN(deg)) return "‚Äî";
  var d=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW","N"];
  return d[Math.round(deg/22.5)];
}
function sizeCanvas(el,ctx){
  var dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
  var r=el.getBoundingClientRect();
  el.width=Math.floor(r.width*dpr); el.height=Math.floor(r.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
function accelPitchRoll(ax,ay,az){
  var RAD=180/Math.PI;
  return { pitch: Math.atan2(-ax, Math.hypot(ay,az))*RAD, roll: Math.atan2(ay, az)*RAD };
}
function fmtTime(s){ var m=Math.floor(s/60), ss=Math.floor(s%60); return (String(m).padStart(2,"0")+":" + String(ss).padStart(2,"0")); }

/* ===== Tabs (robust, hash-aware) ===== */
(function(){
  var tabs = $$(".tabs .tab");
  var map = {tasks:"#view-tasks", notes:"#view-notes", timer:"#view-timer", bpm:"#view-bpm", viz:"#view-viz", range:"#view-range", sensors:"#view-sensors"};

  function show(tabName, updateHash){
    if (updateHash === void 0) updateHash = true;
    var sel = map[tabName]; if(!sel) return;
    Object.values(map).forEach(function(id){ $(id).classList.toggle("hidden", id!==sel); });
    tabs.forEach(function(btn){ btn.setAttribute("aria-selected", btn.dataset.tab===tabName ? "true" : "false"); });
    if(updateHash){ try{ history.replaceState(null,"","#"+tabName); }catch(e){} }
  }

  tabs.forEach(function(btn){
    btn.addEventListener("click", function(){ show(btn.dataset.tab, true); });
    btn.addEventListener("keydown", function(e){
      var i=tabs.indexOf(btn);
      if(e.key==="ArrowRight"){ (tabs[i+1]||tabs[0]).focus(); e.preventDefault(); }
      if(e.key==="ArrowLeft"){  (tabs[i-1]||tabs[tabs.length-1]).focus(); e.preventDefault(); }
    });
  });

  var initial=(location.hash||"#tasks").replace("#","");
  show(map[initial]?initial:"tasks", true);
  addEventListener("hashchange", function(){ var name=(location.hash||"#tasks").replace("#",""); show(map[name]?name:"tasks", false); });
})();

/* ===== Tasks ===== */
(function(){
  var tasks = storage.get("opspad:tasks",[]);
  var list=$("#task-list"), input=$("#task-input"), remaining=$("#remaining");

  function render(){
    list.innerHTML="";
    if(!tasks.length){
      var p=document.createElement("div"); p.className="center"; p.textContent="No tasks yet.";
      list.appendChild(p);
    }else{
      tasks.forEach(function(t,idx){
        var li=document.createElement("li"); li.className="card";
        var row=document.createElement("div"); row.className="row"; row.style.alignItems="center";
        var pill=document.createElement("button"); pill.className="pill"+(t.done?" done":""); pill.type="button";
        pill.onclick=function(){ t.done=!t.done; storage.set("opspad:tasks",tasks); render(); };
        var txt=document.createElement("div"); txt.style.flex="1"; txt.textContent=t.text; if(t.done) txt.classList.add("strike");
        var del=document.createElement("button"); del.className="btn ghost"; del.textContent="Delete";
        del.onclick=function(){ tasks.splice(idx,1); storage.set("opspad:tasks",tasks); render(); };
        row.appendChild(pill); row.appendChild(txt); row.appendChild(del); li.appendChild(row); list.appendChild(li);
      });
    }
    var left=tasks.filter(function(x){return !x.done}).length;
    remaining.textContent = left+" remaining";
  }

  $("#task-form").addEventListener("submit", function(e){
    e.preventDefault();
    var v=input.value.trim(); if(!v) return;
    tasks.unshift({text:v,done:false,ts:Date.now()});
    storage.set("opspad:tasks",tasks);
    input.value=""; render();
  });
  $("#clear-done").onclick=function(){ tasks = tasks.filter(function(t){return !t.done}); storage.set("opspad:tasks",tasks); render(); };

  render();
})();

/* ===== Notes ===== */
(function(){
  var notes = storage.get("opspad:notes",[]);
  var list=$("#note-list"), title=$("#note-title"), body=$("#note-body");

  function render(){
    list.innerHTML="";
    if(!notes.length){
      var p=document.createElement("div"); p.className="center"; p.textContent="No notes yet.";
      list.appendChild(p);
      return;
    }
    notes.forEach(function(n,idx){
      var li=document.createElement("li"); li.className="card";
      var row=document.createElement("div"); row.className="row"; row.style.alignItems="flex-start";
      var col=document.createElement("div"); col.style.flex="1";
      if(n.title){ var h=document.createElement("div"); h.style.fontWeight="700"; h.style.marginBottom="4px"; h.textContent=n.title; col.appendChild(h); }
      var p=document.createElement("div"); p.style.whiteSpace="pre-wrap"; p.textContent=n.body; col.appendChild(p);
      var del=document.createElement("button"); del.className="btn ghost"; del.textContent="Delete";
      del.onclick=function(){ notes.splice(idx,1); storage.set("opspad:notes",notes); render(); };
      row.appendChild(col); row.appendChild(del); li.appendChild(row); list.appendChild(li);
    });
  }

  $("#note-form").addEventListener("submit", function(e){
    e.preventDefault();
    var t=title.value.trim(), b=body.value.trim(); if(!t && !b) return;
    var id = (window.crypto && typeof window.crypto.randomUUID === "function")
      ? window.crypto.randomUUID()
      : Math.random().toString(36).slice(2);
    notes.unshift({id:id, title:t, body:b, ts:Date.now()});
    storage.set("opspad:notes",notes); title.value=""; body.value=""; render();
  });
  render();
})();

/* ===== Timer ===== */
(function(){
  var dur=25*60, left=dur, run=false, raf=null, last=null;
  var read=$("#timer-readout");
  function tick(ts){
    if(last==null) last=ts;
    var dt=(ts-last)/1000; last=ts; left=Math.max(0,left-dt);
    read.textContent=fmtTime(left);
    if(left>0 && run){ raf=requestAnimationFrame(tick); } else { run=false; $("#timer-start").textContent="Start"; last=null; }
  }
  $("#timer-start").onclick=function(){
    if(!run){ run=true; $("#timer-start").textContent="Pause"; if(left<=0) left=dur; raf=requestAnimationFrame(tick); }
    else { run=false; $("#timer-start").textContent="Start"; cancelAnimationFrame(raf); last=null; }
  };
  $("#timer-reset").onclick=function(){ run=false; left=dur; read.textContent=fmtTime(left); $("#timer-start").textContent="Start"; cancelAnimationFrame(raf); last=null; };
  $("#timer-range").oninput=function(e){ dur=Number(e.target.value)*60; left=dur; read.textContent=fmtTime(left); };
  read.textContent=fmtTime(left);
})();

/* ===== BPM ===== */
(function(){
  var taps=[];
  function update(){
    if(taps.length<2){ $("#bpm-value").textContent="‚Äî"; $("#bpm-ms").textContent=""; return; }
    var diffs=taps.slice(1).map(function(x,i){return x-taps[i]});
    var mean=diffs.reduce(function(a,b){return a+b},0)/diffs.length;
    var bpm=60000/mean;
    $("#bpm-value").textContent=(Math.round(bpm*10)/10).toString();
    $("#bpm-ms").textContent="~"+mean.toFixed(1)+" ms/beat";
  }
  $("#bpm-tap").onclick=function(){ taps=[].concat(taps,[performance.now()]).slice(-8); update(); if(navigator.vibrate) navigator.vibrate(12); };
  $("#bpm-reset").onclick=function(){ taps=[]; update(); };
  update();
})();

/* ===== Visualizer ===== */
(function(){
  var canvas=$("#viz-canvas"), ctx=canvas.getContext("2d",{alpha:false});
  sizeCanvas(canvas,ctx); new ResizeObserver(function(){sizeCanvas(canvas,ctx)}).observe(canvas);
  var audioCtx=null, analyser=null, source=null, stream=null, data=null;
  var sensitivity=parseFloat($("#viz-sens").value), circleSize=parseFloat($("#viz-circle").value), rot=0;

  var stops=["#4da3ff","#00f59a","#ff4dff"];
  function hex(h){h=h.replace("#","");if(h.length===3)h=h.split("").map(function(c){return c+c}).join("");var n=parseInt(h,16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255}}
  function lerp(a,b,t){return a+(b-a)*t}
  function mix(c1,c2,t){return{r:Math.round(lerp(c1.r,c2.r,t)),g:Math.round(lerp(c1.g,c2.g,t)),b:Math.round(lerp(c1.b,c2.b,t))}}
  function rgb(c,a){ if(a===void 0)a=1; return"rgba("+c.r+","+c.g+","+c.b+","+a+")" }
  function grad(t){var n=stops.length-1,i=Math.floor(t*n); return mix(hex(stops[i]), hex(stops[Math.min(n,i+1)]), (t*n-i));}

  function drawBars(w,h,b){
    var gap=1, wid=Math.max(1,Math.floor(w/b)-gap);
    for(var i=0;i<b;i++){
      var v=data[i]/255, amp=Math.pow(v*sensitivity,1.08);
      var y=Math.max(1,amp*h), x=i*(wid+gap), py=h-y;
      ctx.fillStyle=rgb(grad(i/(b-1)));
      ctx.fillRect(x,py,wid,y);
    }
  }
  function drawCircle(w,h,b){
    var cx=w/2, cy=h/2, m=Math.min(w,h), r0=m*circleSize, r1=m*Math.min(.49,circleSize+.2);
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(rot); ctx.lineCap="round"; ctx.shadowBlur=14; ctx.shadowColor="rgba(255,255,255,.22)";
    for(var i=0;i<b;i++){
      var v=data[i]/255, amp=Math.pow(v*sensitivity,1.04), a=i/b*Math.PI*2;
      var x1=Math.cos(a)*r0, y1=Math.sin(a)*r0;
      var x2=Math.cos(a)*Math.min(r1,r0+amp*(r1-r0)), y2=Math.sin(a)*Math.min(r1,r0+amp*(r1-r0));
      ctx.strokeStyle=rgb(grad(i/(b-1))); ctx.lineWidth=2+amp*3; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    }
    ctx.restore();
  }
  function loop(){
    if(!analyser) return;
    analyser.getByteFrequencyData(data);
    ctx.fillStyle="rgba(10,10,12,.10)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    var w=canvas.clientWidth, h=canvas.clientHeight, b=data.length;
    ($("#viz-mode").value==="bars")?drawBars(w,h,b):drawCircle(w,h,b);
    requestAnimationFrame(loop);
  }

  $("#viz-start").onclick=function(){
    if(!(window.isSecureContext || location.hostname==="localhost" || location.hostname==="127.0.0.1")){
      $("#viz-status").textContent="Mic requires HTTPS or localhost.";
      return;
    }
    (async function(){
      try{
        $("#viz-status").textContent="Requesting microphone‚Ä¶";
        stream=await navigator.mediaDevices.getUserMedia({audio:true});
        audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        analyser=audioCtx.createAnalyser(); analyser.fftSize=1024; analyser.smoothingTimeConstant=.85;
        source=audioCtx.createMediaStreamSource(stream); source.connect(analyser);
        data=new Uint8Array(analyser.frequencyBinCount);
        $("#viz-status").textContent="Live";
        loop();
      }catch(e){ $("#viz-status").textContent="Mic error: "+(e.message||e.name||e); }
    })();
  };
  $("#viz-stop").onclick=function(){ try{source&&source.disconnect()}catch(e){}; if(stream){stream.getTracks().forEach(function(t){t.stop()})} stream=null; if(audioCtx){try{audioCtx.close()}catch(e){}} analyser=null; $("#viz-status").textContent="Stopped."; };
  $("#viz-sens").oninput=function(e){sensitivity=parseFloat(e.target.value)};
  $("#viz-circle").oninput=function(e){circleSize=parseFloat(e.target.value)};
  document.addEventListener("visibilitychange",function(){ if(document.hidden) $("#viz-stop").click(); });
  addEventListener("pagehide",function(){ $("#viz-stop").click(); });
})();

/* ===== Rangefinder ===== */
(function(){
  var v=$("#range-video"), hud=$("#range-hud"), faceEl=$("#range-face"), distEl=$("#range-distance"), statusEl=$("#range-status");
  var startBtn=$("#range-start"), stopBtn=$("#range-stop"), sensBtn=$("#range-sensors"), hEl=$("#range-height"), uEl=$("#range-units"), calBtn=$("#range-cal"), lockBtn=$("#range-lock");

  var stream=null, sensorsOn=false, locked=false;
  var pitchOri=0, pitchAcc=0, zero=0, height=parseFloat(hEl.value), units=uEl.value;

  function toFeet(m){return m*3.28084}
  function fmt(m){return units==="m" ? ((m<10?m.toFixed(2):m.toFixed(1))+" m") : ((toFeet(m)<10?toFeet(m).toFixed(2):toFeet(m).toFixed(1))+" ft");}
  async function startCam(){
    if(!(window.isSecureContext || location.hostname==="localhost" || location.hostname==="127.0.0.1")){
      statusEl.textContent="Camera requires HTTPS or localhost."; return;
    }
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}, audio:false});
      v.srcObject=stream; await v.play(); statusEl.textContent="Camera live. Calibrate level, then aim at base of target.";
    }catch(e){ statusEl.textContent="Camera error: "+(e.message||e); }
  }
  function stopCam(){ if(stream){ stream.getTracks().forEach(function(t){t.stop()}); stream=null; } v.srcObject=null; statusEl.textContent="Camera stopped."; }

  var face="‚Äî";
  function onMotion(e){
    var a=e.accelerationIncludingGravity||e.acceleration; if(!a) return;
    var pr=accelPitchRoll(a.x||0,a.y||0,a.z||0); pitchAcc=pr.pitch;
    var z=a.z||0, ax=a.x||0, ay=a.y||0; var absZ=Math.abs(z), absX=Math.abs(ax), absY=Math.abs(ay);
    face=(absZ>6&&absZ>absX&&absZ>absY)?(z<0?"face up":"face down"):"vertical"; faceEl.textContent=face;
  }
  function onOrient(e){
    pitchOri = (typeof e.beta === "number") ? e.beta : 0;
  }
  function effectivePitch(){ return Math.abs(pitchAcc)>1 ? pitchAcc : pitchOri; }

  async function enable(){
    try{
      if(typeof window.DeviceMotionEvent!=="undefined" && typeof DeviceMotionEvent.requestPermission==="function"){
        var r=await DeviceMotionEvent.requestPermission(); if(r!=="granted"){ statusEl.textContent="Motion permission denied."; return; }
      }
      if(typeof window.DeviceOrientationEvent!=="undefined" && typeof DeviceOrientationEvent.requestPermission==="function"){ try{ await DeviceOrientationEvent.requestPermission(); }catch(e){} }
      addEventListener("devicemotion", onMotion, true);
      addEventListener("deviceorientation", onOrient, true);
      sensorsOn=true; sensBtn.textContent="Sensors: On"; statusEl.textContent="Sensors enabled.";
    }catch(e){ statusEl.textContent="Sensor error: "+(e.message||e); }
  }
  function disable(){ removeEventListener("devicemotion", onMotion, true); removeEventListener("deviceorientation", onOrient, true); sensorsOn=false; sensBtn.textContent="Enable Sensors"; statusEl.textContent="Sensors off."; }

  function loop(){
    var p=effectivePitch(); var dep=(p - zero);
    hud.textContent="pitch "+Math.round(p)+"¬∞ ‚Ä¢ depression "+Math.round(dep)+"¬∞";
    if(!locked){
      if(dep>1){ var rad=dep*Math.PI/180; var dist=height/Math.tan(rad); distEl.textContent = (isFinite(dist)&&dist<10000) ? ("distance "+fmt(dist)) : "distance ‚Äî"; }
      else { distEl.textContent="distance ‚Äî"; }
    }
    requestAnimationFrame(loop);
  }
  loop();

  startBtn.onclick=startCam; stopBtn.onclick=stopCam;
  sensBtn.onclick=function(){ sensorsOn?disable():enable(); };
  hEl.oninput=function(e){ height=parseFloat(e.target.value) };
  uEl.onchange=function(e){ units=e.target.value; };
  calBtn.onclick=function(){ zero=effectivePitch(); statusEl.textContent="Calibrated at "+Math.round(zero)+"¬∞"; };
  lockBtn.onclick=function(){ locked=!locked; lockBtn.textContent=locked?"Unlock":"Lock"; };

  addEventListener("pagehide",function(){ if(stream){stream.getTracks().forEach(function(t){t.stop()});} });
})();

/* ===== Sensors (attitude + extra sensors) ===== */
(function(){
  var st=$("#sns-status"), vPR=$("#sns-pr"), vHead=$("#sns-head"), vFace=$("#sns-face");
  var g=$("#gyro-canvas"), ctx=g.getContext("2d"); sizeCanvas(g,ctx); new ResizeObserver(function(){sizeCanvas(g,ctx)}).observe(g);
  var calBtn=$("#h-cal"), flipBtn=$("#h-flip"); var zero=0, flip=storage.get("opspad:hflip",false);
  var head=null, face="‚Äî", pitch=0, roll=0;

  function draw(){
    var w=g.clientWidth, h=g.clientHeight, cx=w/2, cy=h/2;
    ctx.clearRect(0,0,w,h);

    var invertedByFace = (face === "face down");
    var inverted = flip ? !invertedByFace : invertedByFace;

    var pxPerDeg = h/90;
    var pitchPx  = (inverted ? -(pitch - zero) : (pitch - zero)) * pxPerDeg;
    var rollRad  = (roll*Math.PI/180) + (inverted ? Math.PI : 0);

    ctx.save(); ctx.translate(cx,cy); ctx.rotate(rollRad);

    ctx.fillStyle = inverted ? "#3a2412" : "#0d1f4a";
    ctx.fillRect(-w, -h*2 + pitchPx, w*2, h*2);
    ctx.fillStyle = inverted ? "#0d1f4a" : "#3a2412";
    ctx.fillRect(-w, 0 + pitchPx, w*2, h*2);

    ctx.strokeStyle="#fff"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-w, pitchPx); ctx.lineTo(w, pitchPx); ctx.stroke();

    ctx.lineWidth=1.3; ctx.strokeStyle="rgba(255,255,255,0.85)"; ctx.fillStyle="rgba(255,255,255,0.92)";
    ctx.font="11px system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial";
    for(var d=-45; d<=45; d+=5){
      if(d===0) continue;
      var y = pitchPx - d*pxPerDeg;
      var major = (d % 10 === 0), len = major ? 26 : 16;
      ctx.beginPath(); ctx.moveTo(-len,y); ctx.lineTo(len,y); ctx.stroke();
      if(major){
        var label = Math.abs(d)+"¬∞";
        ctx.textAlign="left";  ctx.fillText(label, len+6, y+3);
        ctx.textAlign="right"; ctx.fillText(label, -len-6, y+3);
      }
    }

    ctx.restore();
    requestAnimationFrame(draw);
  }
  draw();

  function onMotion(e){
    var a=e.accelerationIncludingGravity||e.acceleration; if(!a) return;
    var pr=accelPitchRoll(a.x||0,a.y||0,a.z||0); pitch=pr.pitch; roll=pr.roll;
    var z=a.z||0, ax=a.x||0, ay=a.y||0; var absZ=Math.abs(z), absX=Math.abs(ax), absY=Math.abs(ay);
    face=(absZ>6&&absZ>absX&&absZ>absY)?(z<0?"face up":"face down"):"vertical";
    vFace.textContent=face; vPR.textContent=(Math.round(pitch)+" / "+Math.round(roll)+" deg");
  }
  function onOrient(e){
    var a = (typeof e.webkitCompassHeading === "number") ? (360 - e.webkitCompassHeading)%360 :
            (typeof e.alpha === "number" ? e.alpha : null);
    if(a!=null){
      head = a<0 ? a+360 : (a>=360 ? a-360 : a);
      vHead.textContent = (Math.round(head)+"¬∞ ("+degreesToCardinal(head)+")");
    }
  }

  $("#sns-orient").onclick=(function(){
    return async function(){
      try{
        if(typeof window.DeviceMotionEvent!=="undefined" && typeof DeviceMotionEvent.requestPermission==="function"){
          var r=await DeviceMotionEvent.requestPermission(); if(r!=="granted"){ st.textContent="Motion permission denied."; return; }
        }
        if(typeof window.DeviceOrientationEvent!=="undefined" && typeof DeviceOrientationEvent.requestPermission==="function"){ try{ await DeviceOrientationEvent.requestPermission(); }catch(e){} }
        addEventListener("devicemotion", onMotion, true);
        addEventListener("deviceorientation", onOrient, true);
        st.textContent="Orientation enabled.";
      }catch(e){ st.textContent="Orientation error: "+(e.message||e); }
    }
  })();

  calBtn.onclick=function(){ zero=pitch; st.textContent="Level set at "+Math.round(zero)+"¬∞"; };
  flipBtn.onclick=function(){ flip=!flip; storage.set("opspad:hflip",flip); st.textContent=flip?"Horizon flipped":"Horizon normal"; };

  // Magnetometer
  var mag=null;
  $("#sns-magnet").onclick=function(){
    if(!('Magnetometer' in window)){ $("#sns-mag-status").textContent="Unsupported"; return; }
    if(!mag){
      try{
        mag=new Magnetometer({frequency:10});
        mag.addEventListener('reading',function(){
          var x=mag.x||0, y=mag.y||0, z=mag.z||0, m=Math.hypot(x,y,z);
          $("#sns-mag").textContent=(x.toFixed(1)+" / "+y.toFixed(1)+" / "+z.toFixed(1));
          $("#sns-mag-mag").textContent=m.toFixed(1);
        });
        mag.addEventListener('error',function(e){
          $("#sns-mag-status").textContent="Error: "+(e.error&&e.error.name?e.error.name:(e.message||e));
        });
        mag.start();
        $("#sns-mag-status").textContent="Running"; $("#sns-magnet").textContent="Magnetometer: On";
      }catch(err){
        $("#sns-mag-status").textContent="Blocked by permissions/policy";
      }
    }else{
      try{mag.stop()}catch(e){} mag=null;
      $("#sns-mag-status").textContent="Stopped"; $("#sns-magnet").textContent="Enable Magnetometer";
    }
  };

  // Ambient Light
  var lux=null;
  $("#sns-light").onclick=function(){
    if(!('AmbientLightSensor' in window)){ $("#sns-lux-status").textContent="Unsupported"; return; }
    if(!lux){
      try{
        lux=new AmbientLightSensor({frequency:5});
        lux.addEventListener('reading',function(){ $("#sns-lux").textContent=lux.illuminance.toFixed(1)+" lux"; });
        lux.addEventListener('error',function(e){
          $("#sns-lux-status").textContent="Error: "+(e.error&&e.error.name?e.error.name:(e.message||e));
        });
        lux.start();
        $("#sns-lux-status").textContent="Running"; $("#sns-light").textContent="Ambient Light: On";
      }catch(err){
        $("#sns-lux-status").textContent="Blocked by permissions/policy";
      }
    }else{
      try{lux.stop()}catch(e){} lux=null;
      $("#sns-lux-status").textContent="Stopped"; $("#sns-light").textContent="Enable Ambient Light";
    }
  };

  // GPS
  var watch=null;
  $("#sns-gps").onclick=function(){
    if(!navigator.geolocation){ $("#sns-gps-status").textContent="Unsupported"; return; }
    if(watch==null){
      watch=navigator.geolocation.watchPosition(function(p){
        var c=p.coords;
        $("#sns-ll").textContent=c.latitude.toFixed(6)+", "+c.longitude.toFixed(6);
        $("#sns-acc").textContent="¬±"+Math.round(c.accuracy)+" m";
        $("#sns-alt").textContent=(c.altitude!=null)?(c.altitude.toFixed(1)+" m"):"‚Äî";
        var sp=(c.speed!=null&&isFinite(c.speed))?(c.speed.toFixed(1)+" m/s ("+(c.speed*3.6).toFixed(1)+" km/h)"):"‚Äî";
        var hd=(c.heading!=null&&isFinite(c.heading))?(Math.round(c.heading)+"¬∞ ("+degreesToCardinal(c.heading)+")"):"‚Äî";
        $("#sns-speed").textContent=sp+" ‚Ä¢ "+hd;
        $("#sns-gps-status").textContent="Watching‚Ä¶";
      }, function(e){ $("#sns-gps-status").textContent="Error: "+e.message; }, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
      $("#sns-gps").textContent="GPS: On";
    }else{
      navigator.geolocation.clearWatch(watch); watch=null;
      $("#sns-gps-status").textContent="Stopped"; $("#sns-gps").textContent="Enable GPS";
    }
  };
})();
</script>
</body>
</html>
